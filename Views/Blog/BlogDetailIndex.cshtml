@model WebApp.ViewModels.BlogViewModel
@{
    ViewData["Title"] = "Blog Detail";
}

<div class="container-fluid bg-primary py-5 bg-header" style="margin-bottom: 90px;">
    <div class="row py-5">
        <div class="col-12 pt-lg-5 mt-lg-5 text-center">
            <h1 class="display-4 text-white animated zoomIn">Blog Detail</h1>
            <a href="/" class="h5 text-white">Home</a>
            <i class="far fa-circle text-white px-2"></i>
            <a href="/Blog/BlogGridIndex" class="h5 text-white">Blog</a>
            <i class="far fa-circle text-white px-2"></i>
            <a href="" class="h5 text-white">Blog Detail</a>
        </div>
    </div>
</div>

<!-- Blog Start -->
<div class="container-fluid py-5 wow fadeInUp" data-wow-delay="0.1s">
    @if (Model != null && Model.Posts != null && Model.Posts.Any())

    {

        var post = Model.Posts.First();
        <!-- Додаємо приховані поля для AJAX -->
        <input type="hidden" id="postId" value="@post.Id" />
        <input type="hidden" id="postSlug" value="@post.Slug" />
    }
    
    <div class="container py-5">
        <div class="row g-5">
            <div class="col-lg-8">
                @if (Model != null && Model.Posts != null && Model.Posts.Any())

                {
                    var post = Model.Posts.First();

                    <!-- Blog Detail Start -->
                    <div class="mb-5">
                        <img class="img-fluid w-100 rounded mb-5" src="@post.ImageSrc" alt="@post.Name">
                        <h1 class="mb-4">@post.Name</h1>
                        <div class="d-flex mb-3">
                            <small class="me-3"><i class="far fa-user text-primary me-2"></i>Admin</small>
                            <small><i class="far fa-calendar-alt text-primary me-2"></i>@post.DataOfPublished.ToString("dd MMM, yyyy")</small>
                        </div>
                        <p>@Html.Raw(post.Context)</p>

                        <!-- Categories -->
                        @if (post.PostCategories != null && post.PostCategories.Any())

                        {
                            <div class="mt-4">
                                <h4>Categories:</h4>
                                <div class="d-flex flex-wrap">
                                    @foreach (var postCategory in post.PostCategories)

                                    {
                                        <a href="@Url.Action("Category", "Blog", new { categoryId = postCategory.Category.Id })"
                                           class="btn btn-primary m-1">@postCategory.Category.Name</a>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Tags -->
                        @if (post.PostTags != null && post.PostTags.Any())

                        {
                            <div class="mt-4">
                                <h4>Tags:</h4>
                                <div class="d-flex flex-wrap">
                                    @foreach (var postTag in post.PostTags)

                                    {
                                        <a href="@Url.Action("Tag", "Blog", new { tagId = postTag.Tag.Id })"
                                           class="btn btn-light m-1">@postTag.Tag.Name</a>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    <!-- Blog Detail End -->
                    <!-- Comment List Start -->
                    <div class="mb-5">
                                                
                        <div class="section-title section-title-sm position-relative pb-3 mb-4">
                            <h3 class="mb-0">Comments</h3>
                        </div>
                        <div id="commentsContainer">
                            <p>Loading comments...</p>
                        </div>
                    </div>

                    




                    @* <script>
                        // Глобальні змінні для відстеження стану
                        let currentReplyTo = null;

                        // Чекаємо поки DOM завантажиться
                        document.addEventListener('DOMContentLoaded', function () {
                            loadComments();
                            initializeCommentForm();
                        });

                        function loadComments() {
                            try {
                                var slugElement = document.getElementById('postSlug');
                                if (!slugElement) {
                                    throw new Error('postSlug element not found');
                                }

                                var slug = slugElement.value;
                                

                                if (!slug) {
                                    throw new Error('Slug is empty');
                                }

                                var container = document.getElementById('commentsContainer');
                                if (container) container.innerHTML = '<p style="color: blue;">🔄 Loading comments from API...</p>';

                                // Використовуємо fetch API (без jQuery)
                                fetch('/Ajax/GetAllComments?slug=' + encodeURIComponent(slug))
                                    .then(function (response) {
                                        if (!response.ok) {
                                            throw new Error('Network error: ' + response.status);
                                        }
                                        return response.json();
                                    })
                                    .then(function (data) {
                                        
                                        if (data.Code === 200) {
                                            var comments = JSON.parse(data.Data);
                                            console.log('📝 Comments loaded:', comments.length);
                                            displayComments(comments);
                                        } else {
                                            throw new Error('API error: ' + data.Message);
                                        }
                                    })
                                    .catch(function (error) {
                                        if (container) container.innerHTML = '<p style="color: red;">❌ Error: ' + error.message + '</p>';
                                    });

                            } catch (error) {
                                console.error('❌ Error:', error);
                                var container = document.getElementById('commentsContainer');
                                if (container) container.innerHTML = '<p style="color: red;">❌ Error: ' + error.message + '</p>';
                            }
                        }

                        function displayComments(comments) {
                            var container = document.getElementById('commentsContainer');

                            if (!comments || comments.length === 0) {
                                container.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                                return;
                            }

                            var html = '<h4 class="mb-4">Comments</h4>';

                            // Групуємо коментарі по рівнях
                            var commentsByLevel = {};
                            comments.forEach(function (comment) {
                                if (!commentsByLevel[comment.Level]) {
                                    commentsByLevel[comment.Level] = [];
                                }
                                commentsByLevel[comment.Level].push(comment);
                            });

                           

                            // Відображаємо коментарі з правильним вкладенням
                            comments.forEach(function (comment) {
                                var margin = comment.Level * 40; // Відступ залежить від рівня
                                var borderClass = comment.Level > 0 ? 'border-start border-3 ps-3' : '';
                                var replyIndicator = comment.Level > 0 ? '<small class="text-primary ms-2">↳ reply</small>' : '';

                                html += `
                                        <div class="d-flex mb-4 ${borderClass}" style="margin-left: ${margin}px;">
                                            <img src="/img/user.jpg" class="rounded me-3" style="width: 45px; height: 45px;">
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <h6 class="mb-1">${comment.UserLogin}</h6>
                                                    <button class="btn btn-outline-primary btn-sm reply-btn"
                                                            data-comment-id="${comment.Id}"
                                                            data-user-name="${comment.UserLogin}">
                                                        <i class="bi bi-reply me-1"></i>Reply
                                                    </button>
                                                </div>
                                                <p class="mb-1">${comment.Text}</p>
                                                <small class="text-muted">${new Date(comment.DateOfCreated).toLocaleString()}</small>
                                                ${replyIndicator}
                                            </div>
                                        </div>
                                    `;
                            });

                            container.innerHTML = html;

                            // Додаємо обробники подій для кнопок Reply
                            setupReplyButtons();
                           
                        }

                        function initializeCommentForm() {
                            const form = document.getElementById('commentForm');

                            if (!form) {
                              
                                return;
                            }

                            

                            // Обробка відправки форми
                            form.addEventListener('submit', function (e) {
                                console.log('🔄 Form submit intercepted, preventing default');
                                e.preventDefault();
                                submitComment();
                            });
                        }

                        function setupReplyButtons() {
                            // Додаємо невелику затримку, щоб гарантувати, що кнопки вже відрендерені
                            setTimeout(() => {
                                const replyButtons = document.querySelectorAll('.reply-btn');
                               

                                replyButtons.forEach(button => {
                                    button.addEventListener('click', function () {
                                        const commentId = this.getAttribute('data-comment-id');
                                        const userName = this.getAttribute('data-user-name');
                                        
                                        replyToComment(commentId, userName);
                                    });
                                });
                            }, 100);
                        }

                        function replyToComment(commentId, userName) {
                            currentReplyTo = commentId;

                            // Оновлюємо UI для показу режиму відповіді
                            document.getElementById('parentCommentId').value = commentId;
                            document.getElementById('replyToUser').textContent = userName;
                            document.getElementById('replyCancel').classList.remove('d-none');

                            // Прокручуємо до форми
                            document.getElementById('commentForm').scrollIntoView({ behavior: 'smooth' });

                            // Фокусуємося на тексті коментаря
                            document.getElementById('commentText').focus();

                           
                        }

                        function cancelReply() {
                            currentReplyTo = null;
                            document.getElementById('parentCommentId').value = '';
                            document.getElementById('replyCancel').classList.add('d-none');
                            console.log('✅ Reply cancelled');
                        }

                        function submitComment() {
                            

                            const submitBtn = document.getElementById('submitComment');
                            const submitText = document.getElementById('submitText');
                            const spinner = document.getElementById('submitSpinner');

                            // Показуємо спінер
                            submitBtn.disabled = true;
                            submitText.textContent = 'Posting Comment...';
                            spinner.classList.remove('d-none');

                            const formData = {
                                userName: document.getElementById('userName').value,
                                userEmail: document.getElementById('userEmail').value,
                                commentText: document.getElementById('commentText').value,
                                parentCommentId: document.getElementById('parentCommentId').value || null,
                                postSlug: document.getElementById('postSlug').value
                            };

                           

                            // Відправляємо на сервер
                            fetch('/Ajax/AddComment', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(formData)
                            })
                                .then(response => {
                                    return response.json();
                                })
                                .then(data => {
                                    
                                    if (data.Code === 200) {
                                        // Очищаємо форму
                                        document.getElementById('commentForm').reset();
                                        cancelReply();

                                        // Показуємо повідомлення про успіх
                                        showAlert('Comment added successfully!', 'success');

                                        // Перезавантажуємо коментарі
                                        setTimeout(() => {
                                            loadComments();
                                        }, 1000);
                                    } else {
                                        showAlert('Error: ' + data.Message, 'error');
                                    }
                                })
                                .catch(error => {
                                    showAlert('Network error. Please try again.', 'error');
                                })
                                .finally(() => {
                                    // Ховаємо спінер
                                    submitBtn.disabled = false;
                                    submitText.textContent = 'Leave Your Comment';
                                    spinner.classList.add('d-none');
                                });
                        }

                        // Функція для показу сповіщень
                        function showAlert(message, type) {
                            const alertDiv = document.createElement('div');
                            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
                            alertDiv.innerHTML = `
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                `;

                            document.querySelector('.bg-light.rounded.p-5').prepend(alertDiv);

                            // Автоматично ховаємо через 5 секунд
                            setTimeout(() => {
                                if (alertDiv.parentElement) {
                                    alertDiv.remove();
                                }
                            }, 5000);
                        }
                    </script>*@
                    <!-- Comment List End -->
                    <!-- Comment Form Start -->
                    <div class="bg-light rounded p-5">
                        <div class="section-title section-title-sm position-relative pb-3 mb-4">
                            <h3 class="mb-0">Leave A Comment</h3>
                        </div>
                        <form id="commentForm">
                            <input type="hidden" id="parentCommentId" name="parentCommentId" value="">
                            <input type="hidden" id="postSlug" value="@Model.Posts.First().Slug">

                            <div class="row g-3">
                                <div class="col-12 col-sm-6">
                                    <input type="text" id="userName" name="userName" class="form-control bg-white border-0"
                                           placeholder="Your Name" style="height: 55px;" required>
                                    <div class="invalid-feedback">Please enter your name.</div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <input type="email" id="userEmail" name="userEmail" class="form-control bg-white border-0"
                                           placeholder="Your Email" style="height: 55px;">
                                </div>
                                <div class="col-12">
                                    <textarea id="commentText" name="commentText" class="form-control bg-white border-0"
                                              rows="5" placeholder="Your Comment" required></textarea>
                                    <div class="invalid-feedback">Please enter your comment.</div>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary w-100 py-3" id="submitComment">
                                        <span id="submitText">Leave Your Comment</span>
                                        <div id="submitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Кнопка скасування відповіді -->
                        <div id="replyCancel" class="mt-3 d-none">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelReply()">
                                <i class="bi bi-x-circle me-1"></i>Cancel Reply
                            </button>
                            <small class="text-muted ms-2">Replying to: <span id="replyToUser"></span></small>
                        </div>
                    </div>
                  
                    <!-- Comment Form End -->
                }

                else

                {
                    <div class="text-center">
                        <h3>Post not found</h3>
                        <p>The requested blog post could not be found.</p>
                    </div>


                    
                }
            </div>

            <!-- Sidebar Start -->
            <div class="col-lg-4">
                <!-- Search Form Start -->
                <div class="mb-5 wow slideInUp" data-wow-delay="0.1s">
                    <form method="get" action="@Url.Action("Search", "Blog")">
                        <div class="input-group">
                            <input type="text" name="keyword" class="form-control p-3" placeholder="Keyword" required>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Search Form End -->
                <!-- Categories Start -->
                <div class="mb-5 wow slideInUp" data-wow-delay="0.1s">
                    <div class="section-title section-title-sm position-relative pb-3 mb-4">
                        <h3 class="mb-0">Categories</h3>
                    </div>
                    <div class="link-animated d-flex flex-column justify-content-start">
                        @if (Model.Categories != null)

                        {
                            @foreach (var category in Model.Categories.Take(5))

                            {
                                <a class="h5 fw-semi-bold bg-light rounded py-2 px-3 mb-2"
                                   href="@Url.Action("Category", "Blog", new { categoryId = category.Id })">
                                    <i class="bi bi-arrow-right me-2"></i>@category.Name
                                </a>
                            }
                        }
                    </div>
                </div>
                <!-- Categories End -->
                <!-- Recent Posts Start -->
                <div class="mb-5 wow slideInUp" data-wow-delay="0.1s">
                    <div class="section-title section-title-sm position-relative pb-3 mb-4">
                        <h3 class="mb-0">Recent Posts</h3>
                    </div>
                    @if (Model.RecentPosts != null && Model.RecentPosts.Any())

                    {
                        @foreach (var recentPost in Model.RecentPosts.Take(5))

                        {
                            <div class="d-flex rounded overflow-hidden mb-3">
                                <img class="img-fluid" src="@recentPost.ImageSrc" style="width: 100px; height: 100px; object-fit: cover;" alt="@recentPost.Name">
                                <a href="@Url.Action("BlogDetailIndex", "Blog", new { id = recentPost.Id })" class="h5 fw-semi-bold d-flex align-items-center bg-light px-3 mb-0">
                                    @recentPost.Name
                                </a>
                            </div>
                        }
                    }

                    else

                    {
                        <p>No recent posts available.</p>
                    }
                </div>
                <!-- Recent Posts End -->
                <!-- Tags Start -->
                <div class="mb-5 wow slideInUp" data-wow-delay="0.1s">
                    <div class="section-title section-title-sm position-relative pb-3 mb-4">
                        <h3 class="mb-0">Tag Cloud</h3>
                    </div>
                    <div class="d-flex flex-wrap m-n1">
                        @if (Model.Tags != null && Model.Tags.Any())

                        {
                            @foreach (var tag in Model.Tags.Take(12))

                            {
                                <a href="@Url.Action("Tag", "Blog", new { tagId = tag.Id })"
                                   class="btn btn-light m-1">@tag.Name</a>
                            }
                        }

                        else

                        {
                            <p>No tags available.</p>
                        }
                    </div>
                </div>
                <!-- Tags End -->
            </div>
            <!-- Sidebar End -->
        </div>
    </div>
</div>
<!-- Blog End -->
@section Scripts {
    <script src="~/js/comments.js"></script>
}


<!-- Vendor Start -->
<div class="container-fluid py-5 wow fadeInUp" data-wow-delay="0.1s">
    <div class="container py-5 mb-5">
        <div class="bg-white">
            <div class="owl-carousel vendor-carousel">
                <img src="~/img/vendor-1.jpg" alt="">
                <img src="~/img/vendor-2.jpg" alt="">
                <img src="~/img/vendor-3.jpg" alt="">
                <img src="~/img/vendor-4.jpg" alt="">
                <img src="~/img/vendor-5.jpg" alt="">
                <img src="~/img/vendor-6.jpg" alt="">
                <img src="~/img/vendor-7.jpg" alt="">
                <img src="~/img/vendor-8.jpg" alt="">
                <img src="~/img/vendor-9.jpg" alt="">
            </div>
        </div>
    </div>
</div>
<!-- Vendor End -->